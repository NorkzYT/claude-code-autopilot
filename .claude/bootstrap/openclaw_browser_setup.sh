#!/usr/bin/env bash
set -euo pipefail

# ─────────────────────────────────────────────────────────────
# openclaw_browser_setup.sh — Docker-based Chromium browser setup
#
# Sets up selenium/standalone-chromium in Docker for CDP access.
# Called by openclaw_setup.sh after gateway install.
#
# Replaces the old Snap Chromium + systemd approach.
# ─────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$(cd "$SCRIPT_DIR/../templates" && pwd 2>/dev/null || echo "")"
OPENCLAW_HOME="${OPENCLAW_HOME:-$HOME/.openclaw}"

# ─── Helpers ────────────────────────────────────────────────
log()  { printf "\n==> %s\n" "$*"; }
warn() { printf "\n[WARN] %s\n" "$*" >&2; }
skip() { printf "    [SKIP] %s\n" "$*"; }
has()  { command -v "$1" >/dev/null 2>&1; }

CDP_PORT=18800
VNC_PORT=5900
NOVNC_PORT=7900
CONTAINER_NAME="openclaw-chrome"
COMPOSE_FILE="$OPENCLAW_HOME/docker-compose.yml"
DATA_DIR="$OPENCLAW_HOME/data"
COOKIES_DIR="$DATA_DIR/cookies"
EXTENSIONS_DIR="$DATA_DIR/extensions"
ENV_FILE="$OPENCLAW_HOME/data/.env"

# ─── 1) Check Docker ────────────────────────────────────────
log "Checking Docker availability..."

if ! has docker; then
  warn "Docker is not installed."
  echo ""
  echo "  Install Docker with one of these methods:"
  echo ""
  echo "  Option A (convenience script):"
  echo "    curl -fsSL https://get.docker.com | sh"
  echo "    sudo usermod -aG docker \$USER"
  echo "    newgrp docker"
  echo ""
  echo "  Option B (package manager):"
  echo "    sudo apt-get install -y docker.io docker-compose-plugin"
  echo "    sudo usermod -aG docker \$USER"
  echo ""
  exit 1
fi

# Check docker daemon is running
if ! docker info &>/dev/null; then
  warn "Docker daemon is not running."
  echo "  Start it with: sudo systemctl start docker"
  echo "  Or: sudo service docker start"
  exit 1
fi

log "Docker is available: $(docker --version 2>/dev/null || echo 'unknown')"

# ─── 2) Create data directories ──────────────────────────────
log "Creating data directories..."

mkdir -p "$COOKIES_DIR"
mkdir -p "$EXTENSIONS_DIR"
log "Data directory: $DATA_DIR"
log "  Cookies:    $COOKIES_DIR"
log "  Extensions: $EXTENSIONS_DIR"

# ─── 3) Generate .env file ───────────────────────────────────
log "Generating .env file..."

generate_env_file() {
  local ext_flags=""
  if [[ -d "$EXTENSIONS_DIR" ]]; then
    for ext_dir in "$EXTENSIONS_DIR"/*/; do
      [[ -d "$ext_dir" ]] || continue
      local ext_name
      ext_name="$(basename "$ext_dir")"
      if [[ -z "$ext_flags" ]]; then
        ext_flags="--load-extension=/extensions/$ext_name"
      else
        ext_flags="$ext_flags,/extensions/$ext_name"
      fi
    done
  fi

  local chrome_args="--no-first-run --disable-features=Translate"
  if [[ -n "$ext_flags" ]]; then
    chrome_args="$chrome_args $ext_flags"
  fi

  cat > "$ENV_FILE" << ENVEOF
# Auto-generated by openclaw_browser_setup.sh
# Regenerated by sync-extension.sh when extensions change
SE_OPTS=--remote-debugging-port=${CDP_PORT}
SE_CHROME_ARGS=${chrome_args}
ENVEOF
  log "Generated: $ENV_FILE"
}

generate_env_file

# ─── 4) Create docker-compose.yml ───────────────────────────
log "Creating docker-compose configuration..."

TEMPLATE_FILE="$TEMPLATE_DIR/docker-compose.openclaw-chrome.yml"
if [[ -f "$COMPOSE_FILE" ]]; then
  skip "docker-compose.yml already exists at $COMPOSE_FILE"
else
  if [[ -f "$TEMPLATE_FILE" ]]; then
    cp "$TEMPLATE_FILE" "$COMPOSE_FILE"
    log "Created: $COMPOSE_FILE"
  else
    warn "Template not found: $TEMPLATE_FILE"
    warn "Creating docker-compose.yml inline..."
    cat > "$COMPOSE_FILE" << COMPOSEYML
services:
  chrome:
    image: selenium/standalone-chromium:latest
    container_name: ${CONTAINER_NAME}
    env_file:
      - ./data/.env
    ports:
      - "${CDP_PORT}:${CDP_PORT}"
      - "${VNC_PORT}:${VNC_PORT}"
      - "${NOVNC_PORT}:${NOVNC_PORT}"
    volumes:
      - openclaw-chrome-profile:/home/seluser/.config/chromium
      - ./data/cookies:/cookies:ro
      - ./data/extensions:/extensions:ro
    environment:
      - SE_SCREEN_WIDTH=1920
      - SE_SCREEN_HEIGHT=1080
      - SE_VNC_NO_PASSWORD=1
      - SE_START_XVFB=true
      - SE_NODE_MAX_SESSIONS=1
    shm_size: 2gb
    restart: always

volumes:
  openclaw-chrome-profile:
COMPOSEYML
    log "Created: $COMPOSE_FILE (inline)"
  fi
fi

# ─── 5) Pull Chromium image ─────────────────────────────────
log "Pulling selenium/standalone-chromium:latest..."

if docker image inspect selenium/standalone-chromium:latest &>/dev/null; then
  skip "Image already pulled"
else
  docker pull selenium/standalone-chromium:latest
  log "Image pulled successfully"
fi

# ─── 6) Start container ─────────────────────────────────────
log "Starting Docker container..."

# Stop existing container if running
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
  docker stop "$CONTAINER_NAME" 2>/dev/null || true
  docker rm "$CONTAINER_NAME" 2>/dev/null || true
  log "Removed existing container"
fi

docker compose -f "$COMPOSE_FILE" up -d
log "Container started"

# ─── 7) Wait for CDP ────────────────────────────────────────
log "Waiting for CDP on port ${CDP_PORT}..."

MAX_WAIT=30
WAITED=0
while ! python3 -c "
import socket, sys
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.settimeout(1)
try:
    s.connect(('127.0.0.1', ${CDP_PORT}))
    s.close()
    sys.exit(0)
except:
    sys.exit(1)
" 2>/dev/null; do
  sleep 1
  WAITED=$((WAITED + 1))
  if [[ $WAITED -ge $MAX_WAIT ]]; then
    warn "Timed out waiting for CDP on port ${CDP_PORT} after ${MAX_WAIT}s"
    warn "Check container logs: docker logs ${CONTAINER_NAME}"
    break
  fi
done

if [[ $WAITED -lt $MAX_WAIT ]]; then
  log "CDP is ready on port ${CDP_PORT} (${WAITED}s)"
fi

# ─── 8) Update OpenClaw config ──────────────────────────────
log "Updating OpenClaw config with CDP URL..."

CDP_URL="http://localhost:${CDP_PORT}"

CONFIG_PATHS=(
  "$OPENCLAW_HOME/openclaw.json"
  "$OPENCLAW_HOME/.openclaw/openclaw.json"
)

for config_path in "${CONFIG_PATHS[@]}"; do
  if [[ ! -f "$config_path" ]]; then
    mkdir -p "$(dirname "$config_path")"
    echo '{}' > "$config_path"
  fi

  python3 -c "
import json
config_path = '$config_path'
with open(config_path) as f:
    data = json.load(f)
browser = data.setdefault('browser', {})
browser['cdpUrl'] = '$CDP_URL'
browser['enabled'] = True
with open(config_path, 'w') as f:
    json.dump(data, f, indent=2)
" 2>/dev/null && log "Updated: $config_path" \
              || warn "Failed to update: $config_path"
done

# ─── 9) Create/update sync-extension.sh ─────────────────────
log "Creating extension sync script..."

SYNC_SCRIPT="$OPENCLAW_HOME/sync-extension.sh"
cat > "$SYNC_SCRIPT" << 'SYNCEOF'
#!/usr/bin/env bash
set -euo pipefail

# sync-extension.sh — Copy an extension to the Docker mount and restart the container
#
# Usage:
#   bash sync-extension.sh <source-path> <extension-name>
#   bash sync-extension.sh                                  (auto-detect from extensions/)
#
# Examples:
#   bash sync-extension.sh /opt/github/MyExt/dist my-ext
#   bash sync-extension.sh ~/projects/my-ext/build my-ext

OPENCLAW_HOME="${OPENCLAW_HOME:-$HOME/.openclaw}"
DATA_DIR="$OPENCLAW_HOME/data"
EXTENSIONS_DIR="$DATA_DIR/extensions"
ENV_FILE="$OPENCLAW_HOME/data/.env"
CONTAINER_NAME="openclaw-chrome"
CDP_PORT=18800

mkdir -p "$EXTENSIONS_DIR"

sync_one_extension() {
  local src="$1"
  local name="$2"
  local target="$EXTENSIONS_DIR/$name"

  echo "Syncing extension '$name' from $src to $target/"
  mkdir -p "$target"
  rsync -a --delete "$src/" "$target/" 2>/dev/null || \
    cp -a "$src/." "$target/"
  echo "  Synced: $name"
}

if [[ $# -ge 2 ]]; then
  # Explicit source and name provided
  EXT_SOURCE="$1"
  EXT_NAME="$2"

  if [[ ! -d "$EXT_SOURCE" ]]; then
    echo "ERROR: Source directory does not exist: $EXT_SOURCE" >&2
    exit 1
  fi

  sync_one_extension "$EXT_SOURCE" "$EXT_NAME"

elif [[ $# -eq 0 ]]; then
  # Auto-detect: sync all extensions from $OPENCLAW_HOME/extensions/
  LOCAL_EXT_DIR="$OPENCLAW_HOME/extensions"
  if [[ ! -d "$LOCAL_EXT_DIR" ]] || [[ -z "$(ls -A "$LOCAL_EXT_DIR" 2>/dev/null)" ]]; then
    echo "ERROR: No extensions found in $LOCAL_EXT_DIR/" >&2
    echo "Usage: bash $0 <source-path> <extension-name>" >&2
    exit 1
  fi

  for ext_dir in "$LOCAL_EXT_DIR"/*/; do
    [[ -d "$ext_dir" ]] || continue
    ext_name="$(basename "$ext_dir")"
    sync_one_extension "$ext_dir" "$ext_name"
  done
else
  echo "Usage: bash $0 <source-path> <extension-name>" >&2
  echo "       bash $0                                   (auto-detect)" >&2
  exit 1
fi

# Rebuild .env with all discovered extensions
echo "Rebuilding .env with discovered extensions..."

EXT_FLAGS=""
for ext_dir in "$EXTENSIONS_DIR"/*/; do
  [[ -d "$ext_dir" ]] || continue
  ext_name="$(basename "$ext_dir")"
  if [[ -z "$EXT_FLAGS" ]]; then
    EXT_FLAGS="--load-extension=/extensions/$ext_name"
  else
    EXT_FLAGS="$EXT_FLAGS,/extensions/$ext_name"
  fi
done

CHROME_ARGS="--no-first-run --disable-features=Translate"
if [[ -n "$EXT_FLAGS" ]]; then
  CHROME_ARGS="$CHROME_ARGS $EXT_FLAGS"
fi

cat > "$ENV_FILE" << ENVEOF
# Auto-generated by sync-extension.sh
# Regenerated each time extensions are synced
SE_OPTS=--remote-debugging-port=${CDP_PORT}
SE_CHROME_ARGS=${CHROME_ARGS}
ENVEOF

echo "Updated: $ENV_FILE"

# Restart container to pick up changes
echo "Restarting container..."
docker restart "$CONTAINER_NAME" 2>/dev/null || echo "WARN: Container restart failed (may not be running)"

echo ""
echo "Extension sync complete. Loaded extensions:"
for ext_dir in "$EXTENSIONS_DIR"/*/; do
  [[ -d "$ext_dir" ]] || continue
  echo "  - $(basename "$ext_dir")"
done
SYNCEOF

chmod +x "$SYNC_SCRIPT"
log "Created: $SYNC_SCRIPT"

# ─── 10) Disable old systemd services ───────────────────────
log "Disabling old systemd browser services..."

for svc in openclaw-xvfb openclaw-chrome openclaw-vnc openclaw-cookies; do
  if systemctl --user is-enabled "$svc" 2>/dev/null; then
    systemctl --user disable --now "$svc" 2>/dev/null || true
    log "Disabled: $svc"
  fi
done

# ─── 11) Summary ────────────────────────────────────────────
echo ""
echo "======================================"
echo "  Docker Browser Setup Complete"
echo "======================================"
echo ""
echo "  Container:  ${CONTAINER_NAME}"
echo "  CDP URL:    http://localhost:${CDP_PORT}"
echo "  Data dir:   ${DATA_DIR}"
echo ""
echo "  VNC Access:"
echo "    VNC client:   vnc://localhost:${VNC_PORT}"
echo "    noVNC (web):  http://localhost:${NOVNC_PORT}"
echo ""
echo "  Manage:"
echo "    docker logs ${CONTAINER_NAME}        # View logs"
echo "    docker restart ${CONTAINER_NAME}     # Restart"
echo "    docker compose -f $COMPOSE_FILE down # Stop"
echo ""
echo "  Sync extensions:"
echo "    bash $SYNC_SCRIPT <source-path> <extension-name>"
echo "    bash $SYNC_SCRIPT   # auto-detect from $OPENCLAW_HOME/extensions/"
echo ""
